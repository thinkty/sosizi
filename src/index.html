<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoSiZi - 소식지 서순 앱</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=z1u96vb25n"></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body style="margin: 0;">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div
      id="map"
      style="height: 100vh; width: 100vw;"
    >
    </div>
    <div id="root"></div>
    <script>
      const walkIcon = [
        `<img src="https://img.icons8.com/fluency-systems-regular/22/ffffff/walking-skin-type-1.png"/>`,
      ].join('');

      const centerPoint = new naver.maps.LatLng(37.561643, 127.027604);

      const mapOptions = {
        center: centerPoint,
        zoom: 17,
        minZoom: 17,
        zoomControl: false,
        mapTypeId: naver.maps.MapTypeId.NORMAL,
      };

      var map = new naver.maps.Map('map', mapOptions);

      // Create boundary of the town
      var boundary = new naver.maps.Polygon({
        map: map,
        paths: [
          [
            new naver.maps.LatLng(37.56421868550275, 127.02976880102375),
            new naver.maps.LatLng(37.56320477108513, 127.03203796448129),
            new naver.maps.LatLng(37.562507348375796, 127.03345418181908),
            new naver.maps.LatLng(37.56079791771342, 127.03198425761022),
            new naver.maps.LatLng(37.5603046516859, 127.03104011886457),
            new naver.maps.LatLng(37.56014593146096, 127.02950552709011),
            new naver.maps.LatLng(37.56004854395593, 127.02899658559534),
            new naver.maps.LatLng(37.5602340323701, 127.02864558691543),
            new naver.maps.LatLng(37.56026648666263, 127.02818344096711),
            new naver.maps.LatLng(37.55985838871628, 127.02748731064575),
            new naver.maps.LatLng(37.55987692858802, 127.0271129139073),
            new naver.maps.LatLng(37.55916744655975, 127.02632315310267),
            new naver.maps.LatLng(37.55846255594703, 127.02589611851411),
            new naver.maps.LatLng(37.55811010725038, 127.02552173158666),
            new naver.maps.LatLng(37.557989523865224, 127.02495429435973),
            new naver.maps.LatLng(37.55793849655609, 127.02430495603343),
            new naver.maps.LatLng(37.55781794910222, 127.02442778164738),
            new naver.maps.LatLng(37.55774835634181, 127.02283659923427),
            new naver.maps.LatLng(37.5589772853168, 127.02281899804075),
            new naver.maps.LatLng(37.55907466261247, 127.0224387388446),
            new naver.maps.LatLng(37.55937610468658, 127.02280735913382),
            new naver.maps.LatLng(37.559974332220676, 127.02328703619571),
            new naver.maps.LatLng(37.56028039633988, 127.02325192745617),
            new naver.maps.LatLng(37.560605012255344, 127.02335136796474),
            new naver.maps.LatLng(37.56089716849818, 127.02356781068762),
            new naver.maps.LatLng(37.561500009977195, 127.02408847106456),
            new naver.maps.LatLng(37.5618802700878, 127.02441021297471),
            new naver.maps.LatLng(37.5625665813267, 127.0259429130359),
            new naver.maps.LatLng(37.56368412555105, 127.02659809690333),
            new naver.maps.LatLng(37.56443997945141, 127.02656883395935),
            new naver.maps.LatLng(37.56471820920189, 127.02665658001844),
            new naver.maps.LatLng(37.56495470451709, 127.02670922682671),
            new naver.maps.LatLng(37.564699665202454, 127.0279728442341),
          ]
        ],
        strokeColor: '#e17183',
        strokeOpacity: 0.8,
        strokeWeight: 5,
      });

      // Place the markers loaded from the config file
      var carDeliveryPoints = [
        {
          quantity: '200',
          id: '11',
          addr: '무학봉길 67',
          marker: [37.56094859752071, 127.03015779894658],
          note: '주민센터 앞 붉은 벽돌 빌라, 3층 문 옆 계단 위에',
          walk: false,
        },
        {
          quantity: '150',
          id: '13',
          addr: '무학봉13길 3-9',
          marker: [37.560899842280875, 127.02910921899645],
          note: '약국 골목 들어가서 왼쪽',
          walk: false,
        },
        {
          quantity: '300',
          id: '10',
          addr: '무학봉12길 2-7',
          marker: [37.56040126651988, 127.02895296034693],
          note: '미용실 골목길 들어가서 왼쪽',
          walk: false,
        },
        {
          quantity: '250',
          id: '14',
          addr: '무학현대아파트',
          marker: [37.56054077172557, 127.02820167020985],
          note: '경비실',
          walk: false,
        },
        {
          quantity: '200',
          id: '16',
          addr: 'KCC스위첸',
          marker: [37.560572838375, 127.02691284848298],
          note: '입구 쪽 아파트 승강기 앞',
          walk: false,
        },
        {
          quantity: '250',
          id: '18',
          addr: '풍림 101동',
          marker: [37.55980667473919, 127.02673721636019],
          note: '제1경비초소',
          walk: false,
        },
        {
          quantity: '150',
          id: '20',
          addr: '풍림 110동',
          marker: [37.55857083379797, 127.02486229362296],
          note: '제4경비초소, 포스터 6장',
          walk: false,
        },
        {
          quantity: '250',
          id: '19',
          addr: '풍림 109동',
          marker: [37.55824005896648, 127.02509966163642],
          note: '경비초소',
          walk: false,
        },
        {
          quantity: '300+300',
          id: '21/22',
          addr: '자이 104동',
          marker: [37.56029153222495, 127.02495573859585],
          note: '관리소 내부 벤치에 놓기',
          walk: false,
        },
        {
          quantity: '150',
          id: '26',
          addr: '극동미라주 임대 104동',
          marker: [37.55954368392059, 127.0233369493517],
          note: '1층 엘리베이터 앞',
          walk: false,
        },
        {
          quantity: '350',
          id: '25',
          addr: '극동미라주 일반 102동',
          marker: [37.55865684531638, 127.02329011420984],
          note: '경비초소',
          walk: false,
        },
        {
          quantity: '300',
          id: '24',
          addr: '금호베스트빌 103동',
          marker: [37.56159828367503, 127.0262915599516],
          note: '제1경비초소',
          walk: false,
        },
        {
          quantity: '300',
          id: '23',
          addr: '금호베스트빌 101동',
          marker: [37.56192453067535, 127.02551584552508],
          note: '경비초소',
          walk: false,
        },
        {
          quantity: '150',
          id: '1',
          addr: '한진그랑빌 아파트 101동',
          marker: [37.563042393339806, 127.02658963981524],
          note: '관리실',
          walk: false,
        },
        {
          quantity: '400',
          id: '15',
          addr: '한신무학아파트',
          marker: [37.56281237159306, 127.02847297208295],
          note: '정문 경비초소',
          walk: false,
        },
        {
          quantity: '300',
          id: '3',
          addr: '왕십리로31나길 33 상왕아파트',
          marker: [37.56350694602661, 127.02862470072367],
          note: '1층 우편함 계단 옆',
          walk: false,
        },
        {
          quantity: '300',
          id: '2',
          addr: '왕십리로33길 7-6',
          marker: [37.56411530896786, 127.02732828725405],
          note: '',
          walk: false,
        },
        {
          quantity: '150',
          id: '4',
          addr: '무학봉15길 26',
          marker: [37.56336268442531, 127.03044163359502],
          note: '산고을칼국수에서 화장실 열쇠 가지고 왼쪽 집으로 들어가서 계단에 놓기',
          walk: false,
        },
        {
          quantity: '150',
          id: '5',
          addr: '무학봉25길 9',
          marker: [37.56264340069574, 127.03147865058267],
          note: '문이 잘 안 열림',
          walk: false,
        },
        {
          quantity: '300',
          id: '6',
          addr: '무학봉25길 6',
          marker: [37.56235583786233, 127.03170395610907],
          note: '',
          walk: false,
        },
        {
          quantity: '350',
          id: '8',
          addr: '무학봉길 81-18',
          marker: [37.56175535179793, 127.03119671405518],
          note: '새마을금고 뒷골목',
          walk: false,
        },
        {
          quantity: '200',
          id: '9',
          addr: '로뎀하우스 커피',
          marker: [37.56187070277743, 127.03085814867092],
          note: '카페 안 식탁에 놓기',
          walk: false,
        },
      ];

      var walkingDeliveryPoints = [
        {
          quantity: '50',
          id: '10 신영',
          addr: '신영지웰 아파트',
          marker: [37.56090317472116, 127.03101592235791],
          note: '경비실 문 앞',
          walk: true,
        },
        {
          quantity: '200',
          id: '12',
          addr: '무학봉15가길 16-2',
          marker: [37.561669124294916, 127.029800434258],
          note: '편지함 위에 있는 열쇠로 문 열고 놓기',
          walk: true,
        },
      ];

      var deliveryPoints = carDeliveryPoints.concat(walkingDeliveryPoints);
      localStorage.setItem('carDeliveryPoints', JSON.stringify(carDeliveryPoints));
      localStorage.setItem('walkingDeliveryPoints', JSON.stringify(walkingDeliveryPoints));
      localStorage.setItem('points', JSON.stringify(deliveryPoints));

      // Create individual markers on the map
      var order = 1;
      for (let i = 0; i < deliveryPoints.length; i++) {
        var deliveryPoint = deliveryPoints[i];

        // Create marker of the delivery point
        var markerContentString = [
          `<div class="marker ${deliveryPoint.walk ? 'walk' : 'car'}">`,
          ` <span class="marker-content">`,
          `   ${deliveryPoint.walk ? walkIcon : order++}`,
          ` </span>`,
          `</div>`,
        ].join('');

        var marker = new naver.maps.Marker({
          position: new naver.maps.LatLng(deliveryPoint.marker[0], deliveryPoint.marker[1]),
          map: map,
          title: deliveryPoint.id,
          icon: {
            content: markerContentString,
            size: new naver.maps.Size(22, 35),
            anchor: new naver.maps.Point(11, 35)
          },
          draggable: false,
        });

        // Save the current selected marker to local storage
        naver.maps.Event.addListener(marker, "click", (currentMarker) => {
          const id = currentMarker.overlay.title;
          if (id == undefined) {
            console.error('Marker ID undefined:', currentMarker);
            return;
          }
          
          // Search the marker details by id
          const markerDetail = deliveryPoints.find(point => point.id === id);
          if (markerDetail == undefined) {
            console.error('Could not find marker by id of', id);
          }

          localStorage.setItem('selectedPoint', JSON.stringify(markerDetail));
          window.dispatchEvent(new Event('storage'));

          // Pan to marker
          map.panTo(new naver.maps.LatLng(markerDetail.marker[0], markerDetail.marker[1]));
        });
      }

      // Remove localStorage 'selectedPoint' if clicked on map background
      naver.maps.Event.addListener(map, 'click', (e) => {
        localStorage.removeItem('selectedPoint');
        window.dispatchEvent(new Event('storage'));
      });

      // // Listen to localstorage changes and pan to the selectedPoint's coordinates if available
      // document.getElementById('root').addEventListener('storage', () => {
      //   console.log("Updated storage");
      // });
    </script>
  </body>
</html>